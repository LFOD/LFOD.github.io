{
  "hash": "6039824c14e771195d62f7bbfce8e126",
  "result": {
    "markdown": "---\ntitle: \"tipr: An R package for sensitivity analyses for unmeasured confounding\"\nauthor: Lucy D'Agostino McGowan\ndate: '2022-09-08'\nslug: tipr-an-r-package-for-sensitivity-to-unmeasured-confounding\ncategories: [\"rstats\"]\ndescription: \"The tipr R package has new updates!\"\n---\n\n::: {.cell}\n\n:::\n\n\nThe `tipr` R package has some new features! And a new and improved API! \n\n## What is `tipr`\n\n`tipr` is an R package that allows you to conduct sensitivity analyses for unmeasured confounders. Why might you want to do that? Well, as it turns out, the assumption of \"no unmeasured confounders\" is integral to any estimation of a causal effect. This assumption is untestable, so often the best we can do is examine how far off our estimates would be should an unmeasured confounder exists, hence **sensitivity analyses**!\n\n## How do I use `tipr`\n\nYou can install the CRAN version by running the following:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"tipr\")\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tipr)\n```\n:::\n\n\nThe package comes with a few example data sets. For example, the dataframe `exdata_rr` is simulated data that can be used to estimate the effect of a binary exposure on a binary outcome, estimated via a risk ratio. This data set has 4 columns:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexdata_rr\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2,000 × 4\n   .unmeasured_confounder measured_confounder exposure\n                    <dbl>               <dbl>    <dbl>\n 1                0.716                -0.890        0\n 2                0.134                -0.249        0\n 3                0.238                -0.104        0\n 4                0.0286                0.165        0\n 5               -0.598                 0.812        0\n 6                0.00419              -0.563        0\n 7               -0.960                -0.559        0\n 8               -1.15                  1.14         0\n 9               -0.374                -1.23         0\n10                1.80                  0.495        0\n# ℹ 1,990 more rows\n# ℹ 1 more variable: outcome <int>\n```\n\n\n:::\n:::\n\n\nUsing this data, we could estimate the exposure-outcome relationship using the measured confounder as follows:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod <- glm(\n  outcome ~ exposure +  measured_confounder,\n  data = exdata_rr,\n  family = poisson)\n\n## calculate the risk ratio by exponentiating \n## the coefficient\ncoef(mod) %>%\n  exp()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        (Intercept)            exposure measured_confounder \n         0.03656318          1.49477100          2.42566275 \n```\n\n\n:::\n:::\n\n\nWe observe a risk ratio of 1.5 for the exposure after adjusting for the measured confounder. We can then get a confidence interval for this output. Note that here we are using a generalized linear model with a log link (via the Poisson family) to estimate this risk ratio. When estimating the risk ratio using this method, it is important to estimate the variability using **robust standard errors** (a sandwich estimator). In R, you can use the `sandwich` and `lmtest` packages to do this.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlmtest::coefci(mod, vcov = sandwich::vcovHC) %>% \n  exp()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                         2.5 %     97.5 %\n(Intercept)         0.02778992 0.04810614\nexposure            1.10497223 2.02207828\nmeasured_confounder 2.13761161 2.75252986\n```\n\n\n:::\n:::\n\n\nOur observed effect, after adjusting for our measured confounder is a risk ratio of 1.5 (95% CI: 1.1, 2.0).\n\nLet's assume our unmeasured confounder is normally distributed with a mean of 0.5 in the exposed group and 0 in the unexposed (and unit variance in both) resulting in a mean difference of 0.5. We can use this to solve for the relationship between the unmeasured confounder and outcome needed to \"tip\" the analysis (that is needed to make the observed effect, 1.5, cross 1).\n\nTo do this, we are going to use the `tip_with_continuous` function. We will set the `effect_observed` to 1.5 and the `exposure_confounder_effect` to 0.5.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntip_with_continuous(\n  effect_observed = 1.5,\n  exposure_confounder_effect = 0.5\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nℹ The observed effect (1.5) WOULD be tipped by 1 unmeasured\n  confounder with the following specifications:\n• estimated difference in scaled means between the\n  unmeasured confounder in the exposed population and\n  unexposed population: 0.5\n• estimated relationship between the unmeasured confounder\n  and the outcome: 2.25\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 5\n  effect_adjusted effect_observed exposure_confounder_effect\n            <dbl>           <dbl>                      <dbl>\n1               1             1.5                        0.5\n# ℹ 2 more variables: confounder_outcome_effect <dbl>,\n#   n_unmeasured_confounders <dbl>\n```\n\n\n:::\n:::\n\n\nThe output is a data frame with 5 variables -- in this case, we are interested in the `confounder_outcome_effect` column, as this tells us the magnitude of the relationship between an unmeasured confounder and outcome needed to tip this analysis. This results in a confounder-outcome effect of 2.25, meaning that a hypothetical unobserved continuous confounder with a mean difference of `0.5` would need a relationship of at least `2.25` with the outcome to tip the analysis at the point estimate.\n\nAlternatively, you could look at a range of potential values for the `exposure_confounder_effect` and plot the relationship.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntip_df <- tip_with_continuous(\n  effect_observed = 1.5,\n  exposure_confounder_effect = seq(0.1, 1, by = 0.1),\n  verbose = FALSE\n)\n```\n:::\n\n\nWe could then plot these results:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\n\nggplot(tip_df,\n       aes(x = exposure_confounder_effect, \n           y = confounder_outcome_effect)) + \n  geom_point() + \n  geom_line() + \n  labs(x = \"Exposure - unmeasured confounder effect\",\n       y = \"Unmeasured confounder - outcome effect\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\nThe line represents the values needed for the unobserved confounder to tip this relationship. \n\nSince this data was simulated, we can calculated what the *actual* effect is.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod_actual <- glm(\n  outcome ~ exposure + measured_confounder + .unmeasured_confounder,\n  data = exdata_rr,\n  family = poisson)\n\ncoef(mod_actual) %>%\n  exp()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n           (Intercept)               exposure \n            0.02450901             0.92108511 \n   measured_confounder .unmeasured_confounder \n            2.43654796             2.41680059 \n```\n\n\n:::\n\n```{.r .cell-code}\nlmtest::coefci(mod_actual, vcov = sandwich::vcovHC) %>% \n  exp()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                            2.5 %     97.5 %\n(Intercept)            0.01801732 0.03333966\nexposure               0.68914975 1.23107900\nmeasured_confounder    2.12823267 2.78952863\n.unmeasured_confounder 2.10602770 2.77343223\n```\n\n\n:::\n:::\n\n\nThe *actual* risk ratio is 0.9 (95% CI: 0.7, 1.2) (so null!). The actual relationship between the unmeasured confounder and outcome is 2.4. We can also calculate the actual exposure - unmeasured confounder effect:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexdata_rr %>%\n  dplyr::group_by(exposure) %>%\n  dplyr::summarise(m = mean(.unmeasured_confounder))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 2\n  exposure      m\n     <dbl>  <dbl>\n1        0 0.0438\n2        1 0.547 \n```\n\n\n:::\n:::\n\n\nThe actual difference is `0.5`. Returning to our plot, we can see that this point is to the right of the \"tipping\" bound, indicating that this unmeasured confounder is \"large\" enough to tip our result (which is exactly what we saw! Before adjusting for this, we had a risk ratio of 1.5, after adjusting we observe a \"tip\" (crossing the null, 1) to 0.9).\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tip_df,\n       aes(x = exposure_confounder_effect, \n           y = confounder_outcome_effect)) + \n  geom_point() + \n  geom_line() + \n  annotate(\n    \"point\",\n    x = 0.5,\n    y = 2.4,\n    size = 2,\n    shape = \"square\",\n    color = \"red\"\n  ) + \n  labs(x = \"Exposure - unmeasured confounder effect\",\n       y = \"Unmeasured confounder - outcome effect\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n\n## The details\n\nThe functions in the tipr package follow a unified grammar. The function names follow this form: `{action}_{effect}_with_{what}`.\n\nFor example, to adjust (`action`) a coefficient (`effect`) with a binary unmeasured confounder (`what`), we use the function `adjust_coef_with_binary()`. \n\n\nBelow is a copy of the table included in a [recent JOSS article](https://doi.org/10.21105/joss.04495) about this package.\n\n**Table 1**. Grammar of `tipr` functions.\n\n+----------+--------------------+----------------------------------------------+\n| category | Function term      | Use                                          |\n+==========+====================+==============================================+\n|**action**| `adjust`           | These functions adjust observed effects,     |\n|          |                    | requiring both the unmeasured        |\n|          |                    | confounder-exposure relationship and         |\n|          |                    | unmeasured confounder-outcome relationship to|\n|          |                    | be specified.                                |\n+----------+--------------------+----------------------------------------------+\n|          | `tip`              | These functions tip observed effects. Only   |\n|          |                    | one relationship, either the unmeasured      |\n|          |                    | confounder-exposure relationship or          |\n|          |                    | unmeasured confounder-outcome relationship   |\n|          |                    | needs to be specified.                       |\n+----------+--------------------+----------------------------------------------+\n|**effect**| `coef`             | These functions specify an observed          |\n|          |                    | coefficient from a linear, log-linear,       |\n|          |                    | logistic, or Cox proportional hazards model  |\n+----------+--------------------+----------------------------------------------+\n|          | `rr`               | These functions specify an observed          |\n|          |                    | relative risk                                |\n+----------+--------------------+----------------------------------------------+\n|          | `or`               | These functions specify an observed          |\n|          |                    | odds ratio                                   |\n+----------+--------------------+----------------------------------------------+\n|          | `hr`               | These functions specify an observed          |\n|          |                    | hazard ratio                                 |\n|          |                    |  \n+----------+--------------------+----------------------------------------------+\n|**what**  | `continuous`       | These functions specify an unmeasured \n|          |                    | standardized Normally distributed confounder. \n|          |                    | These functions will include the parameters\n|          |                    | `exposure_confounder_effect` and \n|          |                    | `confounder_outcome_effect`\n+----------+--------------------+----------------------------------------------+\n|          | `binary`           | These functions specify an unmeasured binary\n|          |                    | confounder. These functions will include the \n|          |                    | parameters `exposed_confounder_prev`, \n|          |                    | `unexposed_confounder_prev`, and\n|          |                    | `confounder_outcome_effect`\n+----------+--------------------+----------------------------------------------+\n|          | `r2`               | These functions specify an unmeasured \n|          |                    | confounder parameterized by specifying the  \n|          |                    | percent of variation in the exposure / outcome  \n|          |                    | explained by the unmeasured confounder. These  \n|          |                    | functions will include the parameters \n|          |                    | `confounder_exposure_r2` and \n|          |                    | `outcome_exposure_r2`\n+----------+--------------------+----------------------------------------------+\n\nYou can find full documentation here: [lucymcgowan.github.io/tipr/](https://lucymcgowan.github.io/tipr/)",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}